pipeline {
  agent any

  environment {
    REPO_URL = "https://github.com/gildoong/django_test.git"
    BRANCH = "main"
    DEPLOY_USER = "vagrant"
    DEPLOY_HOST = "192.168.56.23"
    DEPLOY_DIR = "/home/vagrant/django_test/mysite"
    SSH_CRED_ID = "vagrant"
  }

  stages {
    stage('Checkout') {
      steps {
        echo "[CHECKOUT] Fetching code from ${REPO_URL}"
        git branch: "${BRANCH}", url: "${REPO_URL}"
      }
    }

    stage('Run Remote Deploy') {
      steps {
        echo "[DEPLOY] Running deployment on remote host"
        sshagent (credentials: [env.SSH_CRED_ID]) {
          sh """
            ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} 'bash -s' << 'ENDSSH'
              set -e
              echo "[1] Cleaning old directory..."
              rm -rf ${DEPLOY_DIR}
              mkdir -p ${DEPLOY_DIR}
              cd ${DEPLOY_DIR}

              echo "[2] Downloading latest deploy_remote.sh from GitHub..."
              curl -s -o /tmp/deploy_remote.sh https://raw.githubusercontent.com/gildoong/django_test/${BRANCH}/mysite/scripts/deploy_remote.sh

              if [ ! -s /tmp/deploy_remote.sh ]; then
                echo "❌ Failed to download deploy_remote.sh (404 or empty file)"
                exit 1
              fi

              echo "[3] Running deploy script..."
              chmod +x /tmp/deploy_remote.sh
              /tmp/deploy_remote.sh
            ENDSSH
          """
        }
      }
    }
  }

  post {
    success {
      echo "✅ Deployment completed successfully!"
    }
    failure {
      echo "❌ Deployment failed!"
    }
  }
}

